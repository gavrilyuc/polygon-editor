$.fn.polygon=function(a={}){function b(){m.clearRect(0,0,l.width,l.height),o.forEach(c)}function c(q){m.save(),m.beginPath(),q.points.forEach(function(u){m.lineTo(u.x,u.y)});var r=!0;for(var s in n.colors.polygonFromType)if(q.polygonType==s){var t=n.colors.polygonFromType[s];m.fillStyle=q.isSelected?t.selected:t.default,r=!1;break}r&&(m.fillStyle=q.isSelected?n.colors.polygon.selected:n.colors.polygon.default),m.fill(),m.stroke(),m.closePath(),m.restore(),q.points.forEach(function(u){m.save(),m.translate(u.x,u.y),m.fillStyle=u.isSelected?n.colors.bone.selected:n.colors.bone.default,m.fillRect(-(n.boneSize.width/2),-(n.boneSize.height/2),n.boneSize.width,n.boneSize.height),m.restore()})}function d(q,r,s){var t={points:[],isSelected:!1,polygonType:q};t.points.push({x:r,y:s,isSelected:!1});return t.points.push({x:r,y:s,isSelected:!1}),o.push(t),b(),o.length-1}function e(q,r,s){o[q].points.splice(o[q].points.length-2,0,{x:r,y:s,isSelected:!1}),b()}function f(q,r,s){var u,t=o[s].points,v=t.length-1,w=!1;for(u=0;u<t.length;u++){var z=t[u].x,A=t[v].x,B=t[u].y,C=t[v].y;(B<r&&C>=r||C<r&&B>=r)&&(z<=q||A<=q)&&z+(r-B)/(C-B)*(A-z)<q&&(w=!w),v=u}return w}function g(q,r,s){for(var v,t=o[s].points,u=0;u<t.length-1;u++)if(v={left:t[u].x-n.boneSize.width/2,top:t[u].y-n.boneSize.height/2,right:t[u].x+n.boneSize.width,bottom:t[u].y+n.boneSize.height},v.left<=q&&v.right>=q&&v.top<=r&&v.bottom>=r)return u;return-1}var k=this,l=this.get(0),m=l.getContext('2d'),n=$.extend({boneSize:{width:10,height:10},colors:{bone:{selected:'red',default:'rgba(255,0,0,0.6)'},polygon:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'},polygonFromType:{1:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'},2:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'},3:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'}}},polygonSelectId:'#polygonType'},a),o=[];return function(){var q=-1,r=-1,s=0,t=0;$(k).mousedown(function(u){u.preventDefault();var v=u.offsetX,w=u.offsetY;if(1==u.which){if(u.ctrlKey&&-1==q)return void(q=d($(n.polygonSelectId).val(),v,w));if(u.ctrlKey&&-1<q)return void e(q,v,w);for(var A,z=0;z<o.length;z++){if(A=g(v,w,z),-1<A){s=v,t=w,r=A,q=z,o[z].points[A].isSelected=!0;break}if(f(v,w,z)){q=z,s=v,t=w,o[z].isSelected=!0;break}}}}),$(k).mousemove(function(u){u.preventDefault();var v=u.offsetX,w=u.offsetY;return-1==q?void 0:-1<r&&o[q].points[r].isSelected?(o[q].points[r].x=v,o[q].points[r].y=w,0==r&&(o[q].points[o[q].points.length-1].x=v,o[q].points[o[q].points.length-1].y=w),void b()):void(!o[q].isSelected||(o[q].points.forEach(function(z){z.x+=v-s,z.y+=w-t}),s=v,t=w,b()))}),$(k).mouseup(function(u){u.preventDefault();var v=u.offsetX,w=u.offsetY;return-1==q?void 0:-1<r&&o[q].points[r].isSelected?(o[q].points[r].x=v,o[q].points[r].y=w,o[q].points[r].isSelected=!1,0==r&&(o[q].points[o[q].points.length-1].x=v,o[q].points[o[q].points.length-1].y=w,o[q].points[o[q].points.length-1].isSelected=!1),q=-1,r=-1,void b()):void(!o[q].isSelected||(o[q].points.forEach(function(z){z.x+=v-s,z.y+=w-t,z.isSelected=!1}),o[q].isSelected=!1,s=0,t=0,q=-1,r=-1,b()))})}(),{loadFromJson:function(q){o=JSON.parse(q),b()},getJson:function(){return JSON.stringify(o)}}};