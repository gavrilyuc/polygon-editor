$.fn.polygon=function(a={}){function b(){m.clearRect(0,0,l.width,l.height),q?k.css('border','1px solid red'):k.css('border','1px solid black'),o=jQuery.grep(o,function(r){var s=0<r.points.length;return s&&c(r),s})}function c(r){m.save(),m.beginPath(),r.points.forEach(function(v){m.lineTo(v.x,v.y)}),m.lineTo(r.points[0].x,r.points[0].y);var s=!0;for(var t in n.colors.polygonFromType)if(r.polygonType==t){var u=n.colors.polygonFromType[t];m.fillStyle=q?r.isSelected?n.colors.polygon.selected:u.default:r.isSelected?u.selected:u.default,s=!1;break}s&&(m.fillStyle=r.isSelected?n.colors.polygon.selected:n.colors.polygon.default),m.fill(),m.stroke(),m.closePath(),m.restore(),r.points.forEach(function(v){m.save(),m.translate(v.x,v.y),m.fillStyle=v.isSelected?n.colors.bone.selected:n.colors.bone.default,m.fillRect(-(n.boneSize.width/2),-(n.boneSize.height/2),n.boneSize.width,n.boneSize.height),m.restore()})}function d(r,s,t){var u={points:[],isSelected:!1,polygonType:r};return u.points.push({x:s,y:t,isSelected:!1}),o.push(u),o.length-1}function e(r,s,t){o[r].points.splice(o[r].points.length-1,0,{x:s,y:t,isSelected:!1})}function f(r,s,t){var v,u=o[t].points,w=u.length-1,z=!1;for(v=0;v<u.length;v++){var A=u[v].x,B=u[w].x,C=u[v].y,D=u[w].y;(C<s&&D>=s||D<s&&C>=s)&&(A<=r||B<=r)&&A+(s-C)/(D-C)*(B-A)<r&&(z=!z),w=v}return z}function g(r,s,t){for(var w,u=o[t].points,v=0;v<u.length;v++)if(w={left:u[v].x-n.boneSize.width/2,top:u[v].y-n.boneSize.height/2,right:u[v].x+n.boneSize.width,bottom:u[v].y+n.boneSize.height},w.left<=r&&w.right>=r&&w.top<=s&&w.bottom>=s)return v;return-1}var k=this,l=this.get(0),m=l.getContext('2d'),n=$.extend({boneSize:{width:10,height:10},colors:{bone:{selected:'red',default:'rgba(255,0,0,0.6)'},polygon:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'},polygonFromType:{1:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'},2:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'},3:{selected:'rgba(255,0,0,0.6)',default:'rgba(0,255,0,0.6)'}}},polygonSelectId:'#polygonType',editMode:'#editMode'},a),o=[],q=!1;return function(){var r=-1,s=-1,t=0,u=0;$(n.editMode).click(function(){q=!q,-1<r&&(o[r].isSelected=!1),r=-1,b()}),$(k).mousedown(function(v){v.preventDefault();var w=v.offsetX,z=v.offsetY;if(1==v.which){if(q){if(-1==r){for(var A=0;A<o.length;A++)if(f(w,z,A)){r=A,o[A].isSelected=!0;break}}else v.ctrlKey&&e(r,w,z);return void b()}if(v.ctrlKey&&-1==r)return r=d($(n.polygonSelectId).val(),w,z),void b();if(v.ctrlKey&&-1<r)return e(r,w,z),void b();for(var B,A=0;A<o.length;A++){if(B=g(w,z,A),-1<B){if(v.shiftKey){o[A].points.splice(B,1);break}t=w,u=z,s=B,r=A,o[A].points[B].isSelected=!0;break}if(f(w,z,A)){if(v.shiftKey){o.splice(A,1),r=-1,t=0,u=0;break}r=A,t=w,u=z,o[A].isSelected=!0;break}}b()}}),$(k).mousemove(function(v){v.preventDefault();var w=v.offsetX,z=v.offsetY;return-1==r||q?void 0:-1<s&&o[r].points[s].isSelected?(o[r].points[s].x=w,o[r].points[s].y=z,void b()):void(!o[r].isSelected||(o[r].points.forEach(function(A){A.x+=w-t,A.y+=z-u}),t=w,u=z,b()))}),$(k).mouseup(function(v){v.preventDefault();var w=v.offsetX,z=v.offsetY;return-1==r||q?void 0:-1<s&&o[r].points[s].isSelected?(o[r].points[s].x=w,o[r].points[s].y=z,o[r].points[s].isSelected=!1,r=-1,s=-1,void b()):void(!o[r].isSelected||(o[r].points.forEach(function(A){A.x+=w-t,A.y+=z-u,A.isSelected=!1}),o[r].isSelected=!1,t=0,u=0,r=-1,s=-1,b()))})}(),{loadFromJson:function(r){o=JSON.parse(r),b()},getJson:function(){return JSON.stringify(o)}}};